# NestJS 整合 Prisma

这里采用 Mysql

## 创建数据库

连接数据库并创建一个名为 prisma_dev 的数据库

```shell
//登陆本地mysql 的root账号， -p表示要输入密码
mysql -u root -p
//展示所有的数据库
show databases;
//展示所有的表
show tables;
//创建数据库
create database databaseName;
```

## 安装 Prisma 并初始化

```shell
pnpm add prisma --save-dev

npx prisma init
```

## 配置 Prisma

在生成的配置文件/prisma/schema.prisma 中

```prisma
datasource db {
  provider = "mysql". //哪种数据库
  url      = env("DATABASE_URL") //数据库url
}

generator client {
  provider = "prisma-client-js"
}

// 用户模型
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}
```

DATABASE_URL 为数据库的连接信息,在 prisma 文件夹同级下的.env 文件中配置

```shell
DATABASE_URL="mysql://root:123456@localhost:3306/prisma_dev"
```

## 生成数据表和 client

```shell
npx prisma migrate dev --name init
```

如果后续有修改 schema.prisma(对模型新增字段、新增模型等) ，那么需要重新生成数据表和 client

```shell
npx prisma migrate dev --name change
```

## 使用 client 对数据库进行 CRUD

使用 Prisma Studio GUI 查看并操作数据库

```shell
npx prisma studio
```

## prisma 连接数据库和 nest

创建 prisma 的 module 文件 prisma.module.ts

```typescript
import { Module, Global } from "@nestjs/common";
import { PrismaService } from "./prisma.service";
@Global() // 定义全局之后，任何模块都可以直接使用prismaService
@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PrismaModule {}
```

创建 prisma 的 service 文件 prisma.service.ts

```typescript
import { Injectable, INestApplication } from "@nestjs/common";
import { PrismaClient } from "@prisma/client";

@Injectable()
export class PrismaService extends PrismaClient {
  async enableShutdownHooks(app: INestApplication) {
    this.$on("beforeExit", async () => {
      await app.close();
    });
  }
}
```
